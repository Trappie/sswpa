<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ artist_name }} - Purchase Tickets | Steinway Society of Western Pennsylvania</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="text/javascript" src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body>
    {% include 'nav.html' %}

    <main class="main-content">
        <!-- Page Header -->
        <section class="page-header">
            <div class="container">
                <h1>Purchase Tickets</h1>
            </div>
        </section>

        <!-- Ticket Details -->
        <section class="section">
            <div class="container">
                <div class="ticket-detail-layout">
                    <!-- Event Information -->
                    <div class="event-details-card">
                        <div class="event-header">
                            <div class="event-date-large">
                                <div class="month">MAR</div>
                                <div class="day">23</div>
                                <div class="year">2025</div>
                            </div>
                            <div class="event-title-info">
                                <h2>John Novacek</h2>
                                <p class="event-type">Piano Recital</p>
                                <div class="event-metadata">
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>Sunday, 3:00 PM</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>Kresge Recital Hall<br>College of Fine Arts, Carnegie Mellon University</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="event-description">
                            <h3>About This Concert</h3>
                            <p>Join us for an enchanting evening with renowned pianist John Novacek. This recital is part of our Artist Recital Series, featuring nationally and internationally acclaimed artists performing for the Pittsburgh audience.</p>
                            <p>All recitals include a "Meet the Artist" reception after the performance, providing an opportunity to personally connect with the artist.</p>
                        </div>
                    </div>

                    <!-- Ticket Purchase -->
                    <div class="ticket-purchase-card">
                        <h3>Select Tickets</h3>
                        
                        <div class="ticket-options">
                            <div class="ticket-option">
                                <div class="ticket-info">
                                    <h4>Adult Admission</h4>
                                    <p>General admission for adults</p>
                                </div>
                                <div class="ticket-controls">
                                    <span class="price">$25.00</span>
                                    <div class="quantity-selector">
                                        <button type="button" class="qty-btn" onclick="updateQuantity('adult', -1)">-</button>
                                        <input type="number" id="adult-qty" value="0" min="0" readonly>
                                        <button type="button" class="qty-btn" onclick="updateQuantity('adult', 1)">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="ticket-option">
                                <div class="ticket-info">
                                    <h4>Student Admission</h4>
                                    <p>Discounted admission for students</p>
                                </div>
                                <div class="ticket-controls">
                                    <span class="price">$10.00</span>
                                    <div class="quantity-selector">
                                        <button type="button" class="qty-btn" onclick="updateQuantity('student', -1)">-</button>
                                        <input type="number" id="student-qty" value="0" min="0" readonly>
                                        <button type="button" class="qty-btn" onclick="updateQuantity('student', 1)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="ticket-summary">
                            <div class="summary-line">
                                <span>Total Tickets:</span>
                                <span id="total-tickets">0</span>
                            </div>
                            <div class="summary-line total">
                                <span>Total Amount:</span>
                                <span id="total-amount">$0.00</span>
                            </div>
                        </div>

                        <div id="checkout-form" style="display: none;">
                            <h4>Checkout</h4>
                            
                            <div class="form-group">
                                <label for="buyer-email">Email Address *</label>
                                <input type="email" id="buyer-email" required>
                            </div>
                            
                            <div class="payment-form">
                                <div id="card-container">
                                    <!-- Square payment form will be inserted here -->
                                </div>
                                <button id="pay-button" class="btn btn-primary-light" onclick="processPayment()">
                                    Complete Purchase
                                </button>
                                <button id="cancel-button" class="btn btn-outline-light" onclick="cancelCheckout()">
                                    Cancel
                                </button>
                            </div>
                            
                            <div id="payment-status" style="display: none;"></div>
                        </div>

                        <button id="add-to-cart" class="btn btn-primary-light" disabled onclick="showCheckout()">
                            Purchase Tickets
                        </button>

                        <div class="important-notes">
                            <h4>Important Information</h4>
                            <ul>
                                <li><strong>No Physical Tickets Required</strong> - Your purchase adds you to our pre-paid ticket list</li>
                                <li><strong>Free for SSWPA Members</strong> - Members and CMU students with ID get free admission</li>
                                <li><strong>Box Office Check-in</strong> - Simply provide your name at the door for confirmation</li>
                                <li><strong>Meet the Artist</strong> - Reception included after every performance</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    {% include 'footer.html' %}

    <script src="/static/js/main.js"></script>
    <script>
        // Ticket quantity and pricing logic
        const prices = {
            adult: 25.00,
            student: 10.00
        };
        
        let card;
        let currentTotal = 0;

        function updateQuantity(type, change) {
            const input = document.getElementById(type + '-qty');
            const currentValue = parseInt(input.value) || 0;
            const newValue = Math.max(0, currentValue + change);
            input.value = newValue;
            updateTotal();
        }

        function updateTotal() {
            const adultQty = parseInt(document.getElementById('adult-qty').value) || 0;
            const studentQty = parseInt(document.getElementById('student-qty').value) || 0;
            
            const totalTickets = adultQty + studentQty;
            const totalAmount = (adultQty * prices.adult) + (studentQty * prices.student);
            
            document.getElementById('total-tickets').textContent = totalTickets;
            document.getElementById('total-amount').textContent = '$' + totalAmount.toFixed(2);
            
            currentTotal = totalAmount;
            
            const addToCartBtn = document.getElementById('add-to-cart');
            addToCartBtn.disabled = totalTickets === 0;
        }

        async function initializeSquare() {
            try {
                // Fetch Square configuration from server
                const configResponse = await fetch('/square-config');
                const config = await configResponse.json();
                
                if (config.error) {
                    throw new Error(config.error);
                }
                
                const payments = Square.payments(config.appId, config.locationId);
                
                card = await payments.card();
                await card.attach('#card-container');
            } catch (error) {
                console.error('Square initialization failed:', error);
                document.getElementById('payment-status').innerHTML = '<div class="alert alert-error">Payment system unavailable. Please check your Square configuration.</div>';
                document.getElementById('payment-status').style.display = 'block';
                
                // Don't let Square errors break the checkout form
                card = null;
            }
        }

        function showCheckout() {
            if (currentTotal <= 0) return;
            
            document.getElementById('add-to-cart').style.display = 'none';
            document.getElementById('checkout-form').style.display = 'block';
            
            if (!card) {
                initializeSquare();
            }
        }

        function cancelCheckout() {
            document.getElementById('checkout-form').style.display = 'none';
            document.getElementById('add-to-cart').style.display = 'block';
            document.getElementById('payment-status').style.display = 'none';
        }

        async function processPayment() {
            const emailInput = document.getElementById('buyer-email');
            const email = emailInput.value.trim();
            
            if (!email) {
                alert('Please enter your email address.');
                return;
            }
            
            const statusDiv = document.getElementById('payment-status');
            statusDiv.innerHTML = '<div class="alert alert-info">Processing payment...</div>';
            statusDiv.style.display = 'block';
            
            try {
                if (!card) {
                    statusDiv.innerHTML = '<div class="alert alert-error">Payment system not initialized. Please refresh the page.</div>';
                    return;
                }
                
                const result = await card.tokenize();
                
                if (result.status === 'OK') {
                    const response = await fetch('/process-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            source_id: result.token,
                            amount: Math.round(currentTotal * 100), // Convert to cents
                            currency: 'USD',
                            buyer_email: email
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        statusDiv.innerHTML = '<div class="alert alert-success">' + data.message + '<br>Payment ID: ' + data.payment_id + '</div>';
                        document.getElementById('pay-button').style.display = 'none';
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-error">' + data.message + '</div>';
                    }
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-error">Card tokenization failed. Please check your card details.</div>';
                }
            } catch (error) {
                console.error('Payment error:', error);
                statusDiv.innerHTML = '<div class="alert alert-error">Payment failed. Please try again.</div>';
            }
        }

        // Initialize
        updateTotal();
    </script>
</body>
</html>