<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ artist_name }} - Purchase Tickets | Steinway Society of Western Pennsylvania</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
    <style>
        /* Hide number input spinners */
        .no-spinners::-webkit-outer-spin-button,
        .no-spinners::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .no-spinners {
            -moz-appearance: textfield;
        }
        
        /* Form validation styles */
        .form-group input.invalid {
            border: 2px solid #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .form-group input.valid {
            border: 2px solid #28a745;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        /* Disabled button styles */
        .btn:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            color: #fff;
            opacity: 0.65;
            cursor: not-allowed;
        }
        
        .btn:disabled:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            transform: none;
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #666;
            font-size: 16px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    {% include 'nav.html' %}

    <main class="main-content">
        <!-- Page Header -->
        <section class="page-header">
            <div class="container">
                <h1>Purchase Tickets</h1>
            </div>
        </section>

        <!-- Ticket Details -->
        <section class="section">
            <div class="container">
                <div class="ticket-detail-layout">
                    <!-- Event Information -->
                    <div class="event-details-card">
                        <div class="event-header">
                            <div class="event-date-large">
                                {% set date_parts = recital.event_date.split('-') %}
                                {% set months = ['', 'JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'] %}
                                <div class="month">{{ months[date_parts[1]|int] }}</div>
                                <div class="day">{{ date_parts[2]|int }}</div>
                                <div class="year">{{ date_parts[0] }}</div>
                            </div>
                            <div class="event-title-info">
                                <h2>{{ recital.artist_name }}</h2>
                                <p class="event-type">{{ recital.title }}</p>
                                <div class="event-metadata">
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>{{ recital.event_time }}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>{{ recital.venue }}{% if recital.venue_address %}<br>{{ recital.venue_address }}{% endif %}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="event-description">
                            <h3>About This Concert</h3>
                            {% if recital.description %}
                                <p>{{ recital.description }}</p>
                            {% else %}
                                <p>Join us for an enchanting evening with {{ recital.artist_name }}. This recital is part of our Artist Recital Series, featuring nationally and internationally acclaimed artists performing for the Pittsburgh audience.</p>
                            {% endif %}
                            <p>All recitals include a "Meet the Artist" reception after the performance, providing an opportunity to personally connect with the artist.</p>
                        </div>
                    </div>

                    <!-- Ticket Purchase -->
                    <div class="ticket-purchase-card">
                        <h3>Select Tickets</h3>
                        
                        <div class="ticket-options">
                            {% if ticket_types %}
                                {% for ticket_type in ticket_types %}
                                <div class="ticket-option">
                                    <div class="ticket-info">
                                        <h4>{{ ticket_type.name }}</h4>
                                        <p>{{ ticket_type.description or 'Standard admission' }}</p>
                                    </div>
                                    <div class="ticket-controls">
                                        <span class="price">${{ "%.2f"|format(ticket_type.price_cents / 100) }}</span>
                                        <div class="quantity-selector">
                                            <button type="button" class="qty-btn" onclick="updateQuantity('ticket_{{ ticket_type.id }}', -1)">-</button>
                                            <input type="number" id="ticket_{{ ticket_type.id }}-qty" value="0" min="0" max="{{ ticket_type.max_quantity or 10 }}" onchange="updateTotal()" class="no-spinners">
                                            <button type="button" class="qty-btn" onclick="updateQuantity('ticket_{{ ticket_type.id }}', 1)">+</button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p>No tickets are currently available for this event.</p>
                            {% endif %}
                        </div>

                        <div class="ticket-summary">
                            <div class="summary-line">
                                <span>Total Tickets:</span>
                                <span id="total-tickets">0</span>
                            </div>
                            <div class="summary-line total">
                                <span>Total Amount:</span>
                                <span id="total-amount">$0.00</span>
                            </div>
                        </div>

                        <div id="checkout-form" style="display: none;">
                            <h4>Checkout</h4>
                            
                            <div class="form-group">
                                <label for="buyer-first-name">First Name *</label>
                                <input type="text" id="buyer-first-name" required>
                                <div class="error-message" id="first-name-error">First name is required</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="buyer-last-name">Last Name *</label>
                                <input type="text" id="buyer-last-name" required>
                                <div class="error-message" id="last-name-error">Last name is required</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="buyer-email">Email Address *</label>
                                <input type="email" id="buyer-email" required>
                                <div class="error-message" id="email-error">Please enter a valid email address</div>
                            </div>
                            
                            <div class="payment-form">
                                <div id="card-container">
                                    <!-- Square payment form will be inserted here -->
                                </div>
                                <button id="pay-button" class="btn btn-primary-light" onclick="processPayment()">
                                    Complete Purchase
                                </button>
                                <button id="cancel-button" class="btn btn-outline-light" onclick="cancelCheckout()">
                                    Cancel
                                </button>
                                
                                <div id="payment-loading" class="loading-spinner">
                                    <div class="spinner"></div>
                                    <div class="loading-text">Processing your payment...</div>
                                </div>
                            </div>
                            
                            <div id="payment-status" style="display: none;"></div>
                        </div>

                        <button id="add-to-cart" class="btn btn-primary-light" disabled onclick="showCheckout()">
                            Purchase Tickets
                        </button>

                        <div class="important-notes">
                            <h4>Important Information</h4>
                            <ul>
                                <li><strong>Email Confirmation Required</strong> - Present your email confirmation at the door for entry</li>
                                <li><strong>Free for SSWPA Members</strong> - Members and CMU students with ID get free admission</li>
                                <li><strong>Meet the Artist</strong> - Reception included after every performance</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    {% include 'footer.html' %}

    <script src="/static/js/main.js"></script>
    <script>
        // Ticket quantity and pricing logic
        const recitalId = {{ recital.id }};
        const prices = {
            {% for ticket_type in ticket_types %}
            ticket_{{ ticket_type.id }}: {{ ticket_type.price_cents / 100 }}{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        
        const ticketTypes = {
            {% for ticket_type in ticket_types %}
            ticket_{{ ticket_type.id }}: {
                id: {{ ticket_type.id }},
                name: {{ ticket_type.name|tojson }},
                price_cents: {{ ticket_type.price_cents }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        };
        
        let card;
        let currentTotal = 0;

        function updateQuantity(type, change) {
            const input = document.getElementById(type + '-qty');
            if (!input) {
                console.error('Input element not found for:', type + '-qty');
                return;
            }
            const currentValue = parseInt(input.value) || 0;
            const maxValue = parseInt(input.getAttribute('max')) || 999;
            const newValue = Math.max(0, Math.min(maxValue, currentValue + change));
            input.value = newValue;
            updateTotal();
        }

        function updateTotal() {
            let totalTickets = 0;
            let totalAmount = 0;
            
            // Calculate total for all ticket types
            {% for ticket_type in ticket_types %}
            const ticket{{ ticket_type.id }}Qty = parseInt(document.getElementById('ticket_{{ ticket_type.id }}-qty').value) || 0;
            totalTickets += ticket{{ ticket_type.id }}Qty;
            totalAmount += ticket{{ ticket_type.id }}Qty * prices.ticket_{{ ticket_type.id }};
            {% endfor %}
            
            document.getElementById('total-tickets').textContent = totalTickets;
            document.getElementById('total-amount').textContent = '$' + totalAmount.toFixed(2);
            
            currentTotal = totalAmount;
            
            const addToCartBtn = document.getElementById('add-to-cart');
            addToCartBtn.disabled = totalTickets === 0;
            
            // Update button text based on state
            if (totalTickets === 0) {
                addToCartBtn.textContent = 'Select Tickets to Continue';
            } else {
                addToCartBtn.textContent = 'Purchase Tickets';
            }
        }

        async function initializeSquare() {
            try {
                // Fetch Square configuration from server
                const configResponse = await fetch('/square-config');
                const config = await configResponse.json();
                
                if (config.error) {
                    throw new Error(config.error);
                }
                
                const payments = Square.payments(config.appId, config.locationId);
                
                card = await payments.card();
                await card.attach('#card-container');
            } catch (error) {
                console.error('Square initialization failed:', error);
                document.getElementById('payment-status').innerHTML = '<div class="alert alert-error">Payment system unavailable. Please check your Square configuration.</div>';
                document.getElementById('payment-status').style.display = 'block';
                
                // Don't let Square errors break the checkout form
                card = null;
            }
        }

        function showCheckout() {
            if (currentTotal <= 0) return;
            
            document.getElementById('add-to-cart').style.display = 'none';
            document.getElementById('checkout-form').style.display = 'block';
            
            if (!card) {
                initializeSquare();
            }
        }

        function cancelCheckout() {
            document.getElementById('checkout-form').style.display = 'none';
            document.getElementById('add-to-cart').style.display = 'block';
            document.getElementById('payment-status').style.display = 'none';
        }

        function collectTicketItems() {
            const items = [];
            {% for ticket_type in ticket_types %}
            const qty{{ ticket_type.id }} = parseInt(document.getElementById('ticket_{{ ticket_type.id }}-qty').value) || 0;
            if (qty{{ ticket_type.id }} > 0) {
                items.push({
                    ticket_type_id: {{ ticket_type.id }},
                    quantity: qty{{ ticket_type.id }},
                    price_per_ticket_cents: {{ ticket_type.price_cents }}
                });
            }
            {% endfor %}
            return items;
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateField(input, errorElement, validator = null) {
            const value = input.value.trim();
            const isValid = validator ? validator(value) : value !== '';
            
            if (isValid) {
                input.classList.remove('invalid');
                input.classList.add('valid');
                errorElement.style.display = 'none';
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                errorElement.style.display = 'block';
            }
            
            return isValid;
        }

        function validateForm() {
            const firstNameInput = document.getElementById('buyer-first-name');
            const lastNameInput = document.getElementById('buyer-last-name');
            const emailInput = document.getElementById('buyer-email');
            
            const firstNameError = document.getElementById('first-name-error');
            const lastNameError = document.getElementById('last-name-error');
            const emailError = document.getElementById('email-error');
            
            const isFirstNameValid = validateField(firstNameInput, firstNameError);
            const isLastNameValid = validateField(lastNameInput, lastNameError);
            const isEmailValid = validateField(emailInput, emailError, validateEmail);
            
            return isFirstNameValid && isLastNameValid && isEmailValid;
        }

        async function processPayment() {
            // Validate all form fields
            if (!validateForm()) {
                return; // Stop if validation fails
            }
            
            const firstNameInput = document.getElementById('buyer-first-name');
            const lastNameInput = document.getElementById('buyer-last-name');
            const emailInput = document.getElementById('buyer-email');
            
            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            const email = emailInput.value.trim();
            
            // Show loading spinner and hide buttons
            const payButton = document.getElementById('pay-button');
            const cancelButton = document.getElementById('cancel-button');
            const loadingSpinner = document.getElementById('payment-loading');
            const statusDiv = document.getElementById('payment-status');
            
            payButton.style.display = 'none';
            cancelButton.style.display = 'none';
            loadingSpinner.style.display = 'block';
            statusDiv.style.display = 'none';
            
            // Helper function to show results
            function showPaymentResult(html, isSuccess = false, hasRetryButton = false) {
                loadingSpinner.style.display = 'none';
                statusDiv.innerHTML = html;
                statusDiv.style.display = 'block';
                
                if (!isSuccess && !hasRetryButton) {
                    // Show original buttons again only if there's no retry button
                    payButton.style.display = 'inline-block';
                    cancelButton.style.display = 'inline-block';
                }
            }
            
            try {
                if (!card) {
                    showPaymentResult('<div class="alert alert-error">Payment system not initialized. Please refresh the page.</div>');
                    return;
                }
                
                const result = await card.tokenize();
                
                if (result.status === 'OK') {
                    const response = await fetch('/process-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            source_id: result.token,
                            amount: Math.round(currentTotal * 100), // Convert to cents
                            currency: 'USD',
                            buyer_email: email,
                            buyer_first_name: firstName,
                            buyer_last_name: lastName,
                            recital_id: recitalId,
                            ticket_items: collectTicketItems()
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showPaymentResult('<div class="alert alert-success">' + data.message + '<br>Payment ID: ' + data.payment_id + '</div>', true);
                    } else {
                        // Check if this was rate limited
                        if (data.rate_limited) {
                            showPaymentResult('<div class="alert alert-error">' + data.message + '</div>');
                        }
                        // Check if this was a Square processing failure (has order_id)
                        else if (data.order_id) {
                            showPaymentResult(`
                                <div class="alert alert-error">
                                    ${data.message}
                                    <div style="margin-top: 10px;">
                                        <button onclick="retryPayment(${data.order_id})" class="btn btn-primary-light" style="font-size: 14px; padding: 8px 16px;">
                                            Retry Payment
                                        </button>
                                    </div>
                                </div>
                            `, false, true);
                        } else {
                            showPaymentResult('<div class="alert alert-error">' + data.message + '</div>');
                        }
                    }
                } else {
                    showPaymentResult('<div class="alert alert-error">Card tokenization failed. Please check your card details.</div>');
                }
            } catch (error) {
                console.error('Payment error:', error);
                showPaymentResult('<div class="alert alert-error">Payment failed. Please try again.</div>');
            }
        }

        async function retryPayment(orderId) {
            // Show loading state
            const statusDiv = document.getElementById('payment-status');
            const loadingSpinner = document.getElementById('payment-loading');
            
            statusDiv.style.display = 'none';
            loadingSpinner.style.display = 'block';
            
            // Helper function to show retry results
            function showRetryResult(html, isSuccess = false) {
                loadingSpinner.style.display = 'none';
                statusDiv.innerHTML = html;
                statusDiv.style.display = 'block';
            }
            
            try {
                if (!card) {
                    showRetryResult('<div class="alert alert-error">Payment system not initialized. Please refresh the page.</div>');
                    return;
                }
                
                const result = await card.tokenize();
                
                if (result.status === 'OK') {
                    const response = await fetch('/api/retry-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            order_id: orderId,
                            source_id: result.token
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showRetryResult('<div class="alert alert-success">' + data.message + '<br>Payment ID: ' + data.payment_id + '</div>', true);
                    } else {
                        // Check if retry was rate limited
                        if (data.rate_limited) {
                            showRetryResult('<div class="alert alert-error">' + data.message + '</div>');
                        }
                        // If retry fails, show another retry option
                        else if (data.order_id) {
                            showRetryResult(`
                                <div class="alert alert-error">
                                    ${data.message}
                                    <div style="margin-top: 10px;">
                                        <button onclick="retryPayment(${data.order_id})" class="btn btn-primary-light" style="font-size: 14px; padding: 8px 16px;">
                                            Retry Payment Again
                                        </button>
                                    </div>
                                </div>
                            `);
                        } else {
                            showRetryResult('<div class="alert alert-error">' + data.message + '</div>');
                        }
                    }
                } else {
                    showRetryResult('<div class="alert alert-error">Card tokenization failed. Please check your card details.</div>');
                }
            } catch (error) {
                console.error('Retry payment error:', error);
                showRetryResult('<div class="alert alert-error">Payment retry failed. Please try again.</div>');
            }
        }

        // Add real-time validation event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const firstNameInput = document.getElementById('buyer-first-name');
            const lastNameInput = document.getElementById('buyer-last-name');
            const emailInput = document.getElementById('buyer-email');
            
            const firstNameError = document.getElementById('first-name-error');
            const lastNameError = document.getElementById('last-name-error');
            const emailError = document.getElementById('email-error');
            
            // Add blur event listeners for validation
            firstNameInput.addEventListener('blur', function() {
                validateField(this, firstNameError);
            });
            
            lastNameInput.addEventListener('blur', function() {
                validateField(this, lastNameError);
            });
            
            emailInput.addEventListener('blur', function() {
                validateField(this, emailError, validateEmail);
            });
            
            // Clear validation styles when user starts typing
            firstNameInput.addEventListener('input', function() {
                this.classList.remove('invalid', 'valid');
                firstNameError.style.display = 'none';
            });
            
            lastNameInput.addEventListener('input', function() {
                this.classList.remove('invalid', 'valid');
                lastNameError.style.display = 'none';
            });
            
            emailInput.addEventListener('input', function() {
                this.classList.remove('invalid', 'valid');
                emailError.style.display = 'none';
            });
        });

        // Initialize
        updateTotal();
    </script>
</body>
</html>