<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ artist_name }} - Purchase Tickets | Steinway Society of Western Pennsylvania</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="text/javascript" src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body>
    {% include 'nav.html' %}

    <main class="main-content">
        <!-- Page Header -->
        <section class="page-header">
            <div class="container">
                <h1>Purchase Tickets</h1>
            </div>
        </section>

        <!-- Ticket Details -->
        <section class="section">
            <div class="container">
                <div class="ticket-detail-layout">
                    <!-- Event Information -->
                    <div class="event-details-card">
                        <div class="event-header">
                            <div class="event-date-large">
                                {% set date_parts = recital.event_date.split('-') %}
                                {% set months = ['', 'JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'] %}
                                <div class="month">{{ months[date_parts[1]|int] }}</div>
                                <div class="day">{{ date_parts[2]|int }}</div>
                                <div class="year">{{ date_parts[0] }}</div>
                            </div>
                            <div class="event-title-info">
                                <h2>{{ recital.artist_name }}</h2>
                                <p class="event-type">{{ recital.title }}</p>
                                <div class="event-metadata">
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>{{ recital.event_time }}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>{{ recital.venue }}{% if recital.venue_address %}<br>{{ recital.venue_address }}{% endif %}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="event-description">
                            <h3>About This Concert</h3>
                            {% if recital.description %}
                                <p>{{ recital.description }}</p>
                            {% else %}
                                <p>Join us for an enchanting evening with {{ recital.artist_name }}. This recital is part of our Artist Recital Series, featuring nationally and internationally acclaimed artists performing for the Pittsburgh audience.</p>
                            {% endif %}
                            <p>All recitals include a "Meet the Artist" reception after the performance, providing an opportunity to personally connect with the artist.</p>
                        </div>
                    </div>

                    <!-- Ticket Purchase -->
                    <div class="ticket-purchase-card">
                        <h3>Select Tickets</h3>
                        
                        <div class="ticket-options">
                            {% if ticket_types %}
                                {% for ticket_type in ticket_types %}
                                <div class="ticket-option">
                                    <div class="ticket-info">
                                        <h4>{{ ticket_type.name }}</h4>
                                        <p>{{ ticket_type.description or 'Standard admission' }}</p>
                                    </div>
                                    <div class="ticket-controls">
                                        <span class="price">${{ "%.2f"|format(ticket_type.price_cents / 100) }}</span>
                                        <div class="quantity-selector">
                                            <button type="button" class="qty-btn" onclick="updateQuantity('ticket_{{ ticket_type.id }}', -1)">-</button>
                                            <input type="number" id="ticket_{{ ticket_type.id }}-qty" value="0" min="0" max="{{ ticket_type.max_quantity or 10 }}" readonly>
                                            <button type="button" class="qty-btn" onclick="updateQuantity('ticket_{{ ticket_type.id }}', 1)">+</button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p>No tickets are currently available for this event.</p>
                            {% endif %}
                        </div>

                        <div class="ticket-summary">
                            <div class="summary-line">
                                <span>Total Tickets:</span>
                                <span id="total-tickets">0</span>
                            </div>
                            <div class="summary-line total">
                                <span>Total Amount:</span>
                                <span id="total-amount">$0.00</span>
                            </div>
                        </div>

                        <div id="checkout-form" style="display: none;">
                            <h4>Checkout</h4>
                            
                            <div class="form-group">
                                <label for="buyer-email">Email Address *</label>
                                <input type="email" id="buyer-email" required>
                            </div>
                            
                            <div class="payment-form">
                                <div id="card-container">
                                    <!-- Square payment form will be inserted here -->
                                </div>
                                <button id="pay-button" class="btn btn-primary-light" onclick="processPayment()">
                                    Complete Purchase
                                </button>
                                <button id="cancel-button" class="btn btn-outline-light" onclick="cancelCheckout()">
                                    Cancel
                                </button>
                            </div>
                            
                            <div id="payment-status" style="display: none;"></div>
                        </div>

                        <button id="add-to-cart" class="btn btn-primary-light" disabled onclick="showCheckout()">
                            Purchase Tickets
                        </button>

                        <div class="important-notes">
                            <h4>Important Information</h4>
                            <ul>
                                <li><strong>No Physical Tickets Required</strong> - Your purchase adds you to our pre-paid ticket list</li>
                                <li><strong>Free for SSWPA Members</strong> - Members and CMU students with ID get free admission</li>
                                <li><strong>Box Office Check-in</strong> - Simply provide your name at the door for confirmation</li>
                                <li><strong>Meet the Artist</strong> - Reception included after every performance</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    {% include 'footer.html' %}

    <script src="/static/js/main.js"></script>
    <script>
        // Ticket quantity and pricing logic
        const prices = {
            {% for ticket_type in ticket_types %}
            ticket_{{ ticket_type.id }}: {{ ticket_type.price_cents / 100 }},
            {% endfor %}
        };
        
        let card;
        let currentTotal = 0;

        function updateQuantity(type, change) {
            const input = document.getElementById(type + '-qty');
            const currentValue = parseInt(input.value) || 0;
            const newValue = Math.max(0, currentValue + change);
            input.value = newValue;
            updateTotal();
        }

        function updateTotal() {
            let totalTickets = 0;
            let totalAmount = 0;
            
            // Calculate total for all ticket types
            {% for ticket_type in ticket_types %}
            const ticket{{ ticket_type.id }}Qty = parseInt(document.getElementById('ticket_{{ ticket_type.id }}-qty').value) || 0;
            totalTickets += ticket{{ ticket_type.id }}Qty;
            totalAmount += ticket{{ ticket_type.id }}Qty * prices.ticket_{{ ticket_type.id }};
            {% endfor %}
            
            document.getElementById('total-tickets').textContent = totalTickets;
            document.getElementById('total-amount').textContent = '$' + totalAmount.toFixed(2);
            
            currentTotal = totalAmount;
            
            const addToCartBtn = document.getElementById('add-to-cart');
            addToCartBtn.disabled = totalTickets === 0;
        }

        async function initializeSquare() {
            try {
                // Fetch Square configuration from server
                const configResponse = await fetch('/square-config');
                const config = await configResponse.json();
                
                if (config.error) {
                    throw new Error(config.error);
                }
                
                const payments = Square.payments(config.appId, config.locationId);
                
                card = await payments.card();
                await card.attach('#card-container');
            } catch (error) {
                console.error('Square initialization failed:', error);
                document.getElementById('payment-status').innerHTML = '<div class="alert alert-error">Payment system unavailable. Please check your Square configuration.</div>';
                document.getElementById('payment-status').style.display = 'block';
                
                // Don't let Square errors break the checkout form
                card = null;
            }
        }

        function showCheckout() {
            if (currentTotal <= 0) return;
            
            document.getElementById('add-to-cart').style.display = 'none';
            document.getElementById('checkout-form').style.display = 'block';
            
            if (!card) {
                initializeSquare();
            }
        }

        function cancelCheckout() {
            document.getElementById('checkout-form').style.display = 'none';
            document.getElementById('add-to-cart').style.display = 'block';
            document.getElementById('payment-status').style.display = 'none';
        }

        async function processPayment() {
            const emailInput = document.getElementById('buyer-email');
            const email = emailInput.value.trim();
            
            if (!email) {
                alert('Please enter your email address.');
                return;
            }
            
            const statusDiv = document.getElementById('payment-status');
            statusDiv.innerHTML = '<div class="alert alert-info">Processing payment...</div>';
            statusDiv.style.display = 'block';
            
            try {
                if (!card) {
                    statusDiv.innerHTML = '<div class="alert alert-error">Payment system not initialized. Please refresh the page.</div>';
                    return;
                }
                
                const result = await card.tokenize();
                
                if (result.status === 'OK') {
                    const response = await fetch('/process-payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            source_id: result.token,
                            amount: Math.round(currentTotal * 100), // Convert to cents
                            currency: 'USD',
                            buyer_email: email
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        statusDiv.innerHTML = '<div class="alert alert-success">' + data.message + '<br>Payment ID: ' + data.payment_id + '</div>';
                        document.getElementById('pay-button').style.display = 'none';
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-error">' + data.message + '</div>';
                    }
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-error">Card tokenization failed. Please check your card details.</div>';
                }
            } catch (error) {
                console.error('Payment error:', error);
                statusDiv.innerHTML = '<div class="alert alert-error">Payment failed. Please try again.</div>';
            }
        }

        // Initialize
        updateTotal();
    </script>
</body>
</html>